version: '3'

# these need to be for local development.
# they need to remove the https:

# initial starting point was gleaner: https://github.com/gleanerio/gleaner/blob/master/deployment/gleaner-DS-traefik.yml

# ${GLEANER_ADMIN_DOMAIN}
# ${GLEANER_OSS_DOMAIN}
# ${GLEANER_GRAPH_DOMAIN}

# ${MINIO_ACCESS_KEY}
# ${MINIO_SECRET_KEY}
#
# ${GLEANER_TRAEFIK}
# ${GLEANER_OBJECTS}
# ${GLEANER_GRAPH}

services:
  traefik:
    image: traefik:v2.4
    container_name: traefik
    restart: unless-stopped
    security_opt:
      - no-new-privileges:true
    networks:
      - traefik_proxy
    ports:
      - 8888:80   # can use the
 #     - 8443:443
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik-data:/etc/traefik
      #      - ./traefik-data/traefik.yml:/traefik.yml:ro
      # issues with acme.json being created as  directory
      #      - ./traefik-data/acme/acme.json:/acme.json
      #      - ./traefik-data/acme:/etc/traefik/acme/
#      - ./traefik-data/logs:/logs
#      -  ./traefik-data/traefik.yml:/traefik.yml:ro
#      - ./traefik-data/acme/acme.json:/acme.json
      - ${GLEANER_TRAEFIK}/logs:/logs
 #     -  ${GLEANER_TRAEFIK_YML}/traefik.yml:/traefik.yml:ro
#      - ${GLEANER_TRAEFIK}/acme/acme.json:/acme.json
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.entrypoints=http"
      - "traefik.http.routers.traefik.service=api@internal"
      - "traefik.http.routers.traefik.rule=Host(`${HOST}`) && ( PathPrefix(`/dashboard`) ||  PathPrefix(`/api`) )"
#      - "traefik.http.middlewares.traefik-auth.basicauth.users=`${TRAEFIK_AUTH}`"
      - "traefik.http.middlewares.traefik-auth.basicauth.users=admin:$$apr1$$8o8BiXsR$$a2uH18QqyyAO9vM2nk5gq/"
      - "traefik.http.routers.traefik.middlewares=traefik-auth"
# uses http, since it is local
#      - "traefik.http.middlewares.traefik_prefix.StripPrefix.prefixes=/admin"
#      - "traefik.http.routers.traefik.middlewares=traefik_prefix"
####  https, if it gets setup with https
#      - "traefik.http.routers.traefik.middlewares=traefik_prefix"
#      - "traefik.http.routers.traefik.middlewares=traefik-auth"
#      - "traefik.http.routers.traefik.tls=false"

#      - "--certificatesresolvers.httpresolver.acme.tlschallenge=true"
      #- "--certificatesresolvers.httpresolver.acme.caserver=https://acme-staging-v02.api.letsencrypt.org/directory"
#      - "--certificatesresolvers.httpresolver.acme.email=dwvalentine@ucsd.edu"
#      - "--certificatesresolvers.httpresolver.acme.storage=`${GLEANER_TRAEFIK}`/acme/acme.json"

#########
# blazegraph proxies well. /blazgraph is the route to the ui, and the services
#  localhost:8888/blazegraph
#############
  graph:
    image: nawer/blazegraph
    environment:
      JAVA_XMS: 2g
      JAVA_XMX: 8g
      JAVA_OPTS: -Xmx6g -Xms2g --XX:+UseG1GC
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.triplestore.entrypoints=http"
      - "traefik.http.routers.triplestore.rule=Host(`${HOST}`) && PathPrefix(`/blazegraph`)"

      - "traefik.http.services.triplestore.loadbalancer.server.port=9999"
      - "traefik.docker.network=traefik_proxy"
    volumes:
      - ${GLEANER_GRAPH}:/var/lib/blazegraph
    networks:
      - traefik_proxy

######
## the s3 system does not proxy by path
# localhost:9000    buckets
# localhost:9001  admin console
#####
  s3system:
    image: quay.io/minio/minio
    ports:
      - 9000:9000
      - 9001:9001
    labels:
      - "traefik.enable=false"

    volumes:
      - ${GLEANER_OBJECTS:?GLEANER_OBJECTS environment variable is required}:/data
    environment:
      -  MINIO_ROOT_USER=${MINIO_ROOT_ACCESS_KEY}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_SECRET_KEY}
    networks:
      - traefik_proxy
#    command: ["server", "/data"]
    command: server /data --console-address ":9001"

  sparqlgui:
    image: erikap/yasgui
    restart: unless-stopped
    environment:
      DEFAULT_SPARQL_ENDPOINT: "https://`${GLEANER_GRAPH_DOMAIN}/${SPARQL_DEFAULT_SPARQL_ENDPOINT_PATH}`"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.sparqlgui.entrypoints=http"
      - "traefik.http.routers.sparqlgui.priority=92"
      - "traefik.http.routers.sparqlgui.rule=Host(`${HOST}` )   && PathPrefix(`/sparqlgui`)"
# uses http, since it is local
      - "traefik.http.middlewares.sparqlgui_prefix.StripPrefix.prefixes=/sparqlgui"
      - "traefik.http.routers.sparqlgui.middlewares=sparqlgui_prefix"

      - "traefik.http.routers.sparqlgui.service=sparqlgui"
      - "traefik.http.services.sparqlgui.loadbalancer.server.port=80"
      - "traefik.docker.network=traefik_proxy"
      - "traefik.http.middlewares.sparqlgui.headers.accesscontrolallowmethods=GET,OPTIONS,POST"
      - "traefik.http.middlewares.sparqlgui.headers.accessControlAllowOriginList=*"
      - "traefik.http.middlewares.sparqlgui.headers.accesscontrolmaxage=100"
      - "traefik.http.middlewares.sparqlgui.headers.addvaryheader=true"
    networks:
      - traefik_proxy
networks:
  traefik_proxy:
